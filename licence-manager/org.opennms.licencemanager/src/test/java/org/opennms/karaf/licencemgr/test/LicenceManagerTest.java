package org.opennms.karaf.licencemgr.test;

import org.junit.*;
import org.opennms.karaf.licencemgr.LicenceService;
import org.opennms.karaf.licencemgr.LicenceServiceImpl;
import org.opennms.karaf.licencemgr.StringCrc32Checksum;

import static org.junit.Assert.*;


/**
 * @author cgallen
 *
 */
public class LicenceManagerTest {
	

	static final String licence1a="3C3F786D6C2076657273696F6E3D22312E302220656E636F64696E673D225554462D3822207374616E64616C6F6E653D22796573223F3E3C4C6963656E63654D657461646174613E3C70726F6475637449643E6F72672E6F70656E6E6D732F6F72672E6F70656E6E6D732E6B617261662E6C6963656E63656D616E616765722E7465737462756E646C652F312E302D534E415053484F543C2F70726F6475637449643E3C6C697363656E6365653E4D722043726169672047616C6C656E3C2F6C697363656E6365653E3C6C697363656E636F723E4F70656E4E4D5320554B3C2F6C697363656E636F723E3C73797374656D49643E346164373261333465333633356331622D39396461333332333C2F73797374656D49643E3C7374617274446174653E323031342D31322D33305431323A31343A32352E3435365A3C2F7374617274446174653E3C657870697279446174653E323031342D31322D33305431323A31343A32352E3435365A3C2F657870697279446174653E3C6F7074696F6E733E3C6F7074696F6E3E3C6465736372697074696F6E3E7468697320697320746865206465736372697074696F6E3C2F6465736372697074696F6E3E3C6E616D653E6E65776E616D653C2F6E616D653E3C76616C75653E6E657776616C75653C2F76616C75653E3C2F6F7074696F6E3E3C2F6F7074696F6E733E3C2F4C6963656E63654D657461646174613E:5863AC77AB887BF1D6AD2171CC1A3E616FBB0D7130C02D68BCDDFBBB6EC7ED682BD65239E4E5B85C95300823AB9F3963A137B09B67BA7D2DEBFE5721AF649233369174C0921377503DF41615998C94A48F0EAD3C4F15538984CAA45AC1B9E2308B6BE98B5E56D20190B9CA94AD0A633565E30FF07EA732162495B4D1172BEF2A502B61B9AE768FAA2F687A5426F3F4D62C7B7860C8DE65D4A682AFF8558E044986AF0F31ACCFCA9636803D1E912CA0CDB4FDAE328A17420ABA367372E49E5BA2DF8682CB950FDC3587247EB1FA43CB24186FA8BC00D75A8ADF8932A628B0B050FE0275AD396B125371FD197E339DC091872A2AC1CD768F5A99D0F1AF856E3784:0A66FB8BB04432B7E3DE8F28CE283888-bd3cec2d";
	static final String licence1b="3C3F786D6C2076657273696F6E3D22312E302220656E636F64696E673D225554462D3822207374616E64616C6F6E653D22796573223F3E3C4C6963656E63654D657461646174613E3C70726F6475637449643E6F72672E6F70656E6E6D732F6F72672E6F70656E6E6D732E6B617261662E6C6963656E63656D616E616765722E7465737462756E646C652F312E302D534E415053484F543C2F70726F6475637449643E3C6C697363656E6365653E4D722043726169672047616C6C656E3C2F6C697363656E6365653E3C6C697363656E636F723E4F70656E4E4D5320554B3C2F6C697363656E636F723E3C73797374656D49643E346164373261333465333633356331622D39396461333332333C2F73797374656D49643E3C7374617274446174653E323031342D31322D33305431323A31393A35312E3132365A3C2F7374617274446174653E3C657870697279446174653E323031342D31322D33305431323A31393A35312E3132365A3C2F657870697279446174653E3C6F7074696F6E733E3C6F7074696F6E3E3C6465736372697074696F6E3E7468697320697320746865206465736372697074696F6E3C2F6465736372697074696F6E3E3C6E616D653E6E65776E616D653C2F6E616D653E3C76616C75653E6E657776616C75653C2F76616C75653E3C2F6F7074696F6E3E3C2F6F7074696F6E733E3C2F4C6963656E63654D657461646174613E:7A7436AAC53A8D549AB4AE0DB553382932DC75F30E40872F891FA276EEB96DD5EDAE5D4E2E03619200D1ABFD4C84C63CA5EFB1238D4ACD9B7E18968D43AB92C27FD957B3A1AB6901F4EF9CE6121E0B05DEB38F4501D1F394F6C5DB9D77170440293787B9307AF8A43F69A163E4A73AAF01C93549560726A85486A10ED054ACC5F862BB9E8AA04608FB9958FF1484F59646CA7F18097C57A7F191BFB5F9C0265071F4F3B3F57B2690095833C38DB38125032F442BAF043A240BC2E46450992C49F1575ACB9CBBE1024384B261563BB4B23236A1285B39D64A578247C3D13C30B97AA0281E6D64585D8EF555EE1D7F187EA934051A7A8A9C7B86EDA31277EC7998:0A66FB8BB04432B7E3DE8F28CE283888-f7683be6";
	static final String productId1="org.opennms/org.opennms.karaf.licencemanager.testbundle/1.0-SNAPSHOT";

	static LicenceService licenceService=null;

    @BeforeClass
	public static void oneTimeSetUp() {
		System.out.println("@Before - setting up tests");
		LicenceServiceImpl licenceServiceImpl = new LicenceServiceImpl();

		licenceServiceImpl.setFileUri("./target/licenceService.xml");
		licenceServiceImpl.load();

		licenceService=licenceServiceImpl;

	}

	@AfterClass
	public static void oneTimeTearDown() {
		System.out.println("@After - tearDown");
	}

	@Test
	public void testMakeSystemInstance() {
		String instanceId = licenceService.makeSystemInstance();
		System.out.println("@Test - testMakeSystemInstance(). instanceId="+instanceId);

		StringCrc32Checksum stringCrc32Checksum = new StringCrc32Checksum();
		assertTrue(stringCrc32Checksum.checkCRC(instanceId));

	}


	@Test
	public void testSetWrongSystemInstance() {

		boolean thrown = false;
		try {
			licenceService.setSystemId("ddfgdfhdhjd");
		} catch (RuntimeException e) {
			System.out.println("testSetWrongSystemInstance() 1 Expected Exception:"+e);
			thrown = true;
		}
		assertTrue(thrown);
		
		try {
			licenceService.setSystemId("bc032e68b0defeb5-e7dde04b");
		} catch (RuntimeException e) {
			System.out.println("testSetWrongSystemInstance() 2 Expected Exception:"+e);
			thrown = true;
		}
		assertTrue(thrown);
		
		try {
			licenceService.setSystemId("bc032e68b0de-feb4-e7dde04b");
		} catch (RuntimeException e) {
			System.out.println("testSetWrongSystemInstance() 3 Expected Exception:"+e);
			thrown = true;
		}
		assertTrue(thrown);

	}

	@Test
	public void testSetCorrectSystemInstance() {
		boolean thrown=false;
		try {
			licenceService.setSystemId("bc032e68b0defeb4-e7dde04b");
		} catch (RuntimeException e) {
			System.out.println("testSetCorrectSystemInstance() Unexpected Exception:"+e);
			thrown = true;
		}
		assertFalse(thrown);

	}
	
	@Test
	public void testAddCorrectLicences() {
		// adds same productId licence twice - should only be one licence stored
		boolean thrown=false;
		try {
			licenceService.addLicence(licence1a);
		} catch (RuntimeException e) {
			System.out.println("testAddCorrectLicences() Unexpected Exception:"+e);
			thrown = true;
		}
		
		try {
			licenceService.addLicence(licence1b);
		} catch (RuntimeException e) {
			System.out.println("testAddCorrectLicences() Unexpected Exception:"+e);
			thrown = true;
		}
		
		assertFalse(thrown);

	}
	
	@Test
	public void testAddInCorrectLicence() {
		boolean thrown=false;
		try {
			String licence="bc032e68b0defeb5-e7dde04b"; //incorrect checksum
			licenceService.addLicence(licence);
		} catch (RuntimeException e) {
			System.out.println("testAddInCorrectLicence() expected Exception:"+e);
			thrown = true;
		}
		assertTrue(thrown);

	}
	
	
	@Test
	public void testGetLicence() {
		String licence = licenceService.getLicence(productId1);
		assertNotNull(licence);
		assertEquals(licence1b,licence);
	}

}