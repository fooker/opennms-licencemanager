package org.opennms.karaf.licencemanager;

import org.opennms.karaf.licencemanager.LicenceAuthenticator;
import org.opennms.karaf.licencemgr.AesSymetricKeyCipher;
import org.opennms.karaf.licencemgr.LicenceService;
import org.opennms.karaf.licencemgr.RsaAsymetricKeyCipher;
import org.opennms.karaf.licencemgr.StringCrc32Checksum;
import org.opennms.karaf.licencemgr.metadata.LicenceMetadata;
import org.osgi.framework.ServiceException;

public class LicenceAuthenticatorImpl implements LicenceAuthenticator {

	//LicenceStringPlusCrc=3C3F786D6C2076657273696F6E3D22312E302220656E636F64696E673D225554462D3822207374616E64616C6F6E653D22796573223F3E3C4C6963656E63654D657461646174613E3C70726F6475637449643E6F72672E6F70656E6E6D732F6F72672E6F70656E6E6D732E6B617261662E6C6963656E63656D616E616765722E7465737462756E646C652F312E302D534E415053484F543C2F70726F6475637449643E3C6C697363656E6365653E4D722043726169672047616C6C656E3C2F6C697363656E6365653E3C6C697363656E636F723E4F70656E4E4D5320554B3C2F6C697363656E636F723E3C73797374656D49643E346164373261333465333633356331622D39396461333332333C2F73797374656D49643E3C7374617274446174653E323031342D31322D32395431313A32373A31382E3935305A3C2F7374617274446174653E3C657870697279446174653E323031342D31322D32395431313A32373A31382E3935305A3C2F657870697279446174653E3C6F7074696F6E733E3C6F7074696F6E3E3C6465736372697074696F6E3E7468697320697320746865206465736372697074696F6E3C2F6465736372697074696F6E3E3C6E616D653E6E65776E616D653C2F6E616D653E3C76616C75653E6E657776616C75653C2F76616C75653E3C2F6F7074696F6E3E3C2F6F7074696F6E733E3C2F4C6963656E63654D657461646174613E:2AB32523C0646110DD4E346C273070B651DDB058AE04A960082C74408D5A3271C968CD37294422E3119B0473B49155E3520CA3F55A5AF67633AFFB3459CDD0BC6A7035A014793B6A907C7262D476C57FD707FD593916F894E3F30A0EEB21FD31FE003EFA2E24CFE2BD72325C7F2185E6B2EA7D83AB157EA651223BDB792BA682D3090B377762CA7E8C538599BE6BF1C9BFB84071D97AC0153A6F4DA4F84CA154C27B6F3D7A71790FA279B76AE757A391E585A68E67FE174718CCCC7B42FDD2F1376407AC215E32B1D62E1D6B6C6D668E1C3E3AF3D36974718FBDE9382ADF2369E3E3D1B7132FA928C04FBBD2807A1B445C498161110FE06475D5E1A1E719DA1F:18F64CAADA6A106AD84809FF5A08401A-97d5e60c
	//@Test generateKeys() privateKeyEnryptedStrr=4C4588766A68992D39960C385718C679D58E456369A22C7DD98AE1E853B8AEECD1460D7C683BB485693B88F84D047EB86F6C31EB036C9F6C6F6924BE12B533093FB18DDA85CCB5B77F2DDD9E7DAD3E3BA4839A9771C252BD7E4502E9AB3964AC21CA2A4D9B7BE656F61A9687DA5D4CCCAA141074B2C99EEC77D421CC7C84EA1EDA621A31BD780F8BBDE3352703212452DBA0940DD7D9FD245DA790963CE768DE6EA78A501BCF659FD978B95BF5C6E874AADC5D0E771A1CFBE84A0BE95393574A880A8BE0FCB91BB96338C10234A11C10D0B97214FA529671C4F4D50877344A0664450C74E1B36902BB926F6B7CFDC8487706A8117E30749F81939C0D14B31BDA177868F14283377158394081E55DF36F481EAAB6896CB76EAB228A84FF42A7A9D475EBB37D0A237E5488B404BD3854142671BCA3BD3FADEC2F2A38A7F0877492501160B79FCCC6FEB2F335F59B4BA16EAE7EDD317AD5591143B7371E2E9A3EE648970FD95B6FE9C00C9D684F191170D760749F3D436465CC50052931BF7024040E0A1E96C8585DFC68A2C8F2383C0214DDE56C1838044F5A180B91F3E26861B8D8CEA9759F386D784564D7DE0388B20AB808E98EB52D73D7DEB6B759636AD77081036822D2266F464FB5A82A86104408EDA2B6CEA6D732E09532433B790FCADD91353508EDD423DF28C5F6034D2AC125741AF1F3B567104288E20F343933956B10739B60B524D9A038CBD55C1F8AA9D7BF2E29A5D967506579A43B4444919BB5752BD22110A4D563E22CDCD99C6BE8001A30D1DBE936671117542FA70DB4E94917432D2896CC9D0D2EBCBBFB527ED2F6137DD4095EB2A400F930AF871B90E354FD4B6BFCC0B7D3D24F45067EC4A052D7E0BA17CA01BA25A93707DBB0614F18B035C8F552A791DC6ED2F08FC2FE889F773E2F485FE5DC5601420F41EFF36062FEF0622C4E28A1BFFD843D86A7FDBEAAE1192C4577C8381BD86378F7133A8FC8638649B9293795EF9F5F5668B0640A926F7A7D461314FDA36BD3A522186957511104A379FFC4B527189698BB63FE3F9EF0AE5C6AE9E8FFAF61886DA956B7B76A41BE7B4CCA8EC313836A376FC0E8014DFF5FD0545C1578EA282F102BE13956B9A57C1225CC81116B2F455394C59BB52DA8594F6E412F464FBE022953796C961C21C05AD89D83E645889F6AC35A6E82D3DB2CE67690EC737193D683713E6AEDF72D0D9B434DC41EB0F7CD97CFB054A236167DB46ED09838FD293D91F020AC92732748FE6B277F850816736AED1FE580E52F0301A3791D2FE7788D96FC7A1C7277CE60EAE70695EF56A4AF6AD80AC8E0EC967C0A4F49BF58318F883B117E2B6E53F3D581A9262231201D5738070C6FA10FB42D33B4AA9A1FBF175E638C03317C92BDBCDFFC1736AF6C5AA05EBDF411C401633BA11B35605E238DDA506EB70601FA849828ACDBF3D07A1FC8EDAF1DCF38DFEC1AF4C777D480F10F81314122E5353E57

	// to test use command
	// licence-mgr:add org.opennms/org.opennms.karaf.licencemanager.testbundle/1.0-SNAPSHOT  3C3F786D6C2076657273696F6E3D22312E302220656E636F64696E673D225554462D3822207374616E64616C6F6E653D22796573223F3E3C4C6963656E63654D657461646174613E3C70726F6475637449643E6F72672E6F70656E6E6D732F6F72672E6F70656E6E6D732E6B617261662E6C6963656E63656D616E616765722E7465737462756E646C652F312E302D534E415053484F543C2F70726F6475637449643E3C6C697363656E6365653E4D722043726169672047616C6C656E3C2F6C697363656E6365653E3C6C697363656E636F723E4F70656E4E4D5320554B3C2F6C697363656E636F723E3C73797374656D49643E346164373261333465333633356331622D39396461333332333C2F73797374656D49643E3C7374617274446174653E323031342D31322D32395431313A32373A31382E3935305A3C2F7374617274446174653E3C657870697279446174653E323031342D31322D32395431313A32373A31382E3935305A3C2F657870697279446174653E3C6F7074696F6E733E3C6F7074696F6E3E3C6465736372697074696F6E3E7468697320697320746865206465736372697074696F6E3C2F6465736372697074696F6E3E3C6E616D653E6E65776E616D653C2F6E616D653E3C76616C75653E6E657776616C75653C2F76616C75653E3C2F6F7074696F6E3E3C2F6F7074696F6E733E3C2F4C6963656E63654D657461646174613E:2AB32523C0646110DD4E346C273070B651DDB058AE04A960082C74408D5A3271C968CD37294422E3119B0473B49155E3520CA3F55A5AF67633AFFB3459CDD0BC6A7035A014793B6A907C7262D476C57FD707FD593916F894E3F30A0EEB21FD31FE003EFA2E24CFE2BD72325C7F2185E6B2EA7D83AB157EA651223BDB792BA682D3090B377762CA7E8C538599BE6BF1C9BFB84071D97AC0153A6F4DA4F84CA154C27B6F3D7A71790FA279B76AE757A391E585A68E67FE174718CCCC7B42FDD2F1376407AC215E32B1D62E1D6B6C6D668E1C3E3AF3D36974718FBDE9382ADF2369E3E3D1B7132FA928C04FBBD2807A1B445C498161110FE06475D5E1A1E719DA1F:18F64CAADA6A106AD84809FF5A08401A-97d5e60c
	
	
	private final String productId="org.opennms/org.opennms.karaf.licencemanager.testbundle/1.0-SNAPSHOT";
	private final String privateKeyEnryptedStr="4C4588766A68992D39960C385718C679D58E456369A22C7DD98AE1E853B8AEECD1460D7C683BB485693B88F84D047EB86F6C31EB036C9F6C6F6924BE12B533093FB18DDA85CCB5B77F2DDD9E7DAD3E3BA4839A9771C252BD7E4502E9AB3964AC21CA2A4D9B7BE656F61A9687DA5D4CCCAA141074B2C99EEC77D421CC7C84EA1EDA621A31BD780F8BBDE3352703212452DBA0940DD7D9FD245DA790963CE768DE6EA78A501BCF659FD978B95BF5C6E874AADC5D0E771A1CFBE84A0BE95393574A880A8BE0FCB91BB96338C10234A11C10D0B97214FA529671C4F4D50877344A0664450C74E1B36902BB926F6B7CFDC8487706A8117E30749F81939C0D14B31BDA177868F14283377158394081E55DF36F481EAAB6896CB76EAB228A84FF42A7A9D475EBB37D0A237E5488B404BD3854142671BCA3BD3FADEC2F2A38A7F0877492501160B79FCCC6FEB2F335F59B4BA16EAE7EDD317AD5591143B7371E2E9A3EE648970FD95B6FE9C00C9D684F191170D760749F3D436465CC50052931BF7024040E0A1E96C8585DFC68A2C8F2383C0214DDE56C1838044F5A180B91F3E26861B8D8CEA9759F386D784564D7DE0388B20AB808E98EB52D73D7DEB6B759636AD77081036822D2266F464FB5A82A86104408EDA2B6CEA6D732E09532433B790FCADD91353508EDD423DF28C5F6034D2AC125741AF1F3B567104288E20F343933956B10739B60B524D9A038CBD55C1F8AA9D7BF2E29A5D967506579A43B4444919BB5752BD22110A4D563E22CDCD99C6BE8001A30D1DBE936671117542FA70DB4E94917432D2896CC9D0D2EBCBBFB527ED2F6137DD4095EB2A400F930AF871B90E354FD4B6BFCC0B7D3D24F45067EC4A052D7E0BA17CA01BA25A93707DBB0614F18B035C8F552A791DC6ED2F08FC2FE889F773E2F485FE5DC5601420F41EFF36062FEF0622C4E28A1BFFD843D86A7FDBEAAE1192C4577C8381BD86378F7133A8FC8638649B9293795EF9F5F5668B0640A926F7A7D461314FDA36BD3A522186957511104A379FFC4B527189698BB63FE3F9EF0AE5C6AE9E8FFAF61886DA956B7B76A41BE7B4CCA8EC313836A376FC0E8014DFF5FD0545C1578EA282F102BE13956B9A57C1225CC81116B2F455394C59BB52DA8594F6E412F464FBE022953796C961C21C05AD89D83E645889F6AC35A6E82D3DB2CE67690EC737193D683713E6AEDF72D0D9B434DC41EB0F7CD97CFB054A236167DB46ED09838FD293D91F020AC92732748FE6B277F850816736AED1FE580E52F0301A3791D2FE7788D96FC7A1C7277CE60EAE70695EF56A4AF6AD80AC8E0EC967C0A4F49BF58318F883B117E2B6E53F3D581A9262231201D5738070C6FA10FB42D33B4AA9A1FBF175E638C03317C92BDBCDFFC1736AF6C5AA05EBDF411C401633BA11B35605E238DDA506EB70601FA849828ACDBF3D07A1FC8EDAF1DCF38DFEC1AF4C777D480F10F81314122E5353E57";
	private final String challengeKeyEnryptedStr="4C4588766A68992D39960C385718C679D58E456369A22C7DD98AE1E853B8AEECD1460D7C683BB485693B88F84D047EB86F6C31EB036C9F6C6F6924BE12B533093FB18DDA85CCB5B77F2DDD9E7DAD3E3BA4839A9771C252BD7E4502E9AB3964AC21CA2A4D9B7BE656F61A9687DA5D4CCCAA141074B2C99EEC77D421CC7C84EA1EDA621A31BD780F8BBDE3352703212452DBA0940DD7D9FD245DA790963CE768DE6EA78A501BCF659FD978B95BF5C6E874AADC5D0E771A1CFBE84A0BE95393574A880A8BE0FCB91BB96338C10234A11C10D0B97214FA529671C4F4D50877344A0664450C74E1B36902BB926F6B7CFDC8487706A8117E30749F81939C0D14B31BDA177868F14283377158394081E55DF36F481EAAB6896CB76EAB228A84FF42A7A9D475EBB37D0A237E5488B404BD3854142671BCA3BD3FADEC2F2A38A7F0877492501160B79FCCC6FEB2F335F59B4BA16EAE7EDD317AD5591143B7371E2E9A3EE648970FD95B6FE9C00C9D684F191170D760749F3D436465CC50052931BF7024040E0A1E96C8585DFC68A2C8F2383C0214DDE56C1838044F5A180B91F3E26861B8D8CEA9759F386D784564D7DE0388B20AB808E98EB52D73D7DEB6B759636AD77081036822D2266F464FB5A82A86104408EDA2B6CEA6D732E09532433B790FCADD91353508EDD423DF28C5F6034D2AC125741AF1F3B567104288E20F343933956B10739B60B524D9A038CBD55C1F8AA9D7BF2E29A5D967506579A43B4444919BB5752BD22110A4D563E22CDCD99C6BE8001A30D1DBE936671117542FA70DB4E94917432D2896CC9D0D2EBCBBFB527ED2F6137DD4095EB2A400F930AF871B90E354FD4B6BFCC0B7D3D24F45067EC4A052D7E0BA17CA01BA25A93707DBB0614F18B035C8F552A791DC6ED2F08FC2FE889F773E2F485FE5DC5601420F41EFF36062FEF0622C4E28A1BFFD843D86A7FDBEAAE1192C4577C8381BD86378F7133A8FC8638649B9293795EF9F5F5668B0640A926F7A7D461314FDA36BD3A522186957511104A379FFC4B527189698BB63FE3F9EF0AE5C6AE9E8FFAF61886DA956B7B76A41BE7B4CCA8EC313836A376FC0E8014DFF5FD0545C1578EA282F102BE13956B9A57C1225CC81116B2F455394C59BB52DA8594F6E412F464FBE022953796C961C21C05AD89D83E645889F6AC35A6E82D3DB2CE67690EC737193D683713E6AEDF72D0D9B434DC41EB0F7CD97CFB054A236167DB46ED09838FD293D91F020AC92732748FE6B277F850816736AED1FE580E52F0301A3791D2FE7788D96FC7A1C7277CE60EAE70695EF56A4AF6AD80AC8E0EC967C0A4F49BF58318F883B117E2B6E53F3D581A9262231201D5738070C6FA10FB42D33B4AA9A1FBF175E638C03317C92BDBCDFFC1736AF6C5AA05EBDF411C401633BA11B35605E238DDA506EB70601FA849828ACDBF3D07A1FC8EDAF1DCF38DFEC1AF4C777D480F10F81314122E5353E57";

	private LicenceService licenceService= null;

	public LicenceAuthenticatorImpl(LicenceService licenceService){
		if (licenceService==null) throw new RuntimeException("LicenceAuthenticatoOldImpl: licenceService cannot be null");

		this.licenceService=licenceService;

		String systemId =licenceService.getSystemId();
		if (systemId==null) throw new ServiceException("systemId cannot be null");

		String licencewithCRC = licenceService.getLicence(productId);

		if (licencewithCRC==null) {
			System.out.println("No licence installed for productId:'"+productId+"'");
			throw new ServiceException("No licence installed for productId:'"+productId+"'");
		}

		// check and remove checksum
		StringCrc32Checksum stringCrc32Checksum = new StringCrc32Checksum();
		String licenceStr= stringCrc32Checksum.removeCRC(licencewithCRC);
		if (licenceStr==null) {
			System.out.println("licence checksum incorrect for productId:'"+productId+"'");
			throw new ServiceException("licence checksum incorrect for productId:'"+productId+"'");
		}

		// split components of licence string
		String[] components = licenceStr.split(":");
		if (components.length!=3) {
			System.out.println("incorrectly formatted licence string for productId:'"+productId+"'");
			throw new ServiceException("incorrectly formatted licence string for productId:'"+productId+"'");
		}

		String receivedLicenceMetadataHexStr=components[0];
		String receivedEncryptedHashStr=components[1];
		String receivedAesSecretKeyStr=components[2];

		// decode licence private key before using
		AesSymetricKeyCipher aesCipher = new AesSymetricKeyCipher();
		aesCipher.setEncodedSecretKeyStr(receivedAesSecretKeyStr);

		String decryptedPrivateKeyStr= aesCipher.aesDecryptStr(privateKeyEnryptedStr);

		//decrypt encrypted hash of metadata 
		RsaAsymetricKeyCipher rsaAsymetricKeyCipher = new RsaAsymetricKeyCipher();
		rsaAsymetricKeyCipher.setPrivateKeyStr(decryptedPrivateKeyStr);

		String decriptedHashStr= rsaAsymetricKeyCipher.rsaDecryptString(receivedEncryptedHashStr);

		// verify hash of licence metadata matches decrypted hash
		LicenceMetadata licenceMetadata= new LicenceMetadata();
		licenceMetadata.fromHexString(receivedLicenceMetadataHexStr);
		String sha256Hash = licenceMetadata.sha256Hash();

		if (! sha256Hash.equals(decriptedHashStr)) {
			System.out.println("licence not verified  for productId:'"+productId+"'");
			throw new ServiceException("licence not verified  for productId:'"+productId+"'");
		}

		// check metadata matches expected values
		if (! productId.equals(licenceMetadata.getProductId())){
			System.out.println("licence productId='"+licenceMetadata.getProductId()+"' does not match expected productId:'"+productId+"'");
			throw new ServiceException("licence not verified  for productId:'"+productId+"'");
		}

		// check system id. If systemID == ALL_SYSTEM_IDS then this test is passed
		if (! systemId.equals(licenceMetadata.getSystemId()) && ! "ALL_SYSTEM_IDS".equals(licenceMetadata.getSystemId())) {
			System.out.println("licence systemId='"+licenceMetadata.getSystemId()+"' does not match expected systemId:'"+productId+"'");
			throw new ServiceException("licence systemId='"+licenceMetadata.getSystemId()+"' does not match expected systemId:'"+productId+"'");
		}

		// TODO licenceService.autehnticated licence 
		System.out.println("LicenceAuthenticator authenticated licence for productId="+productId);
		System.out.println("Licence Metadata xml="+licenceMetadata.toXml());


	}

}
